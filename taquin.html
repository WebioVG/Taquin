<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="style.css">

    <title>Taquin</title>
</head>

<body>

    <div class="container">
        <header class="header">
            <div class="turns">Counter: 0</div>
            <h1 class="title">Taquin</h1>
            <div class="timer">0s</div>
        </header>

        <div class="taquin_display">
            <div id="square1" class="square" data-key="1">1</div>
            <div id="square2" class="square" data-key="2">2</div>
            <div id="square3" class="square" data-key="3">3</div>
            <div id="square4" class="square" data-key="4">4</div>
            <div id="square5" class="square" data-key="5">5</div>
            <div id="square6" class="square" data-key="6">6</div>
            <div id="square7" class="square" data-key="7">7</div>
            <div id="square8" class="square" data-key="8">8</div>
            <div id="square9" class="square" data-key="9">9</div>
            <div id="square10" class="square" data-key="10">10</div>
            <div id="square11" class="square" data-key="11">11</div>
            <div id="square12" class="square" data-key="12">12</div>
            <div id="square13" class="square" data-key="13">13</div>
            <div id="square14" class="square" data-key="14">14</div>
            <div id="square15" class="square" data-key="15">15</div>
            <div id="square16" class="square" data-key="16"></div>
        </div>

        <div class="menu">
            <div>
                <div class="stop-button">Stop</div>
            </div>
            <div>
                <div class="play-button">Play</div>
            </div>
            <div>
                <div class="retry-button">Retry</div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- <script src="script.js"></script> -->
    <script>

        ///////////////////////
        // DECLARE VARIABLES //
        ///////////////////////
        
        let random1 = 0, random2 = 0;
        let timerIsRunning = false, gameIsRunning = false, godModIsRunning = false;
        let change1T, change1L, change2T, change2L;
        let i, i2;
        let squareAtBlank;

        ///////////////////////
        // Get HTML elements //
        ///////////////////////

        let squares = $('.square');

        ///////////////
        // FUNCTIONS //
        ///////////////

        // FUNCTION - Change the square positions randomly
        function mixGame() {

            // Stop the transition to prevent problems such as getting wrong top and left values
            $('.square').css({
                'transition-duration': '0ms',
            });
            $('.square').css({
                'transition-duration': '0ms',
            });

            // Get the square which is at the blank position
            for (let square of squares) {
                if (Math.floor($(square).position().left) == 300 &&
                Math.floor($(square).position().top) == 300) {
                    squareAtBlank = $(square);
                }
            }

            // Get the top and left values of the blank and the square at blank position
            let blankT = Math.floor($('#square16').position().top);
            let blankL = Math.floor($('#square16').position().left);
            let squareAtBlankT = Math.floor(squareAtBlank.position().top);
            let squareAtBlankL = Math.floor(squareAtBlank.position().left);

            // Put the blank at its initial position
            $('#square16').css({
                left: `${squareAtBlankL}px`,
                top: `${squareAtBlankT}px`,
            });
            squareAtBlank.css({
                left: `${blankL}px`,
                top: `${blankT}px`,
            });


            // Mix 100 times two random squares
            for (let i = 0; i < 100; i++) {

                // Generate 2 different random numbers between 0 and 15
                random1 = Math.floor(Math.random() * 15 + 1);
                do {
                    random2 = Math.floor(Math.random() * 15 + 1);
                } while (random2 == random1);

                // Get the top and left values of two random squares
                change1T = $(`#square${random1}`).position().top;
                change1L = $(`#square${random1}`).position().left;
                change2T = $(`#square${random2}`).position().top;
                change2L = $(`#square${random2}`).position().left;

                // Change their positions
                $(`#square${random1}`).css({
                    left: `${change2L}px`,
                    top: `${change2T}px`,
                });

                $(`#square${random2}`).css({
                    left: `${change1L}px`,
                    top: `${change1T}px`,
                });
            }

            // Reassign the transition duration
            $('.square').css({
                'transition-duration': '500ms',
            });
        }

        // Function - Load/Cancel the timer and displays it
        function loadTimer() {
            let time = 0

            // Load the timer
            if (!timerIsRunning) {
                i = setInterval(function () {
                    time++;

                    $('.timer').text(`${time}s`);
                }, 1000);

                timerIsRunning = true;
            } else /*Cancel the timer*/ {
                clearInterval(i);

                time = 0;
                $('.timer').text(`${time}s`);

                timerIsRunning = false;
            }
        }

        // Function - Enable or disable godmod
        function godMod() {
            if (!godModIsRunning) {
                // Disable the actual event which checks the click on adjacent squares
                $('.square').off('click');

                // Applicate a new event without checking adjacent squares
                $('.square').click(function test() {

                    // Get the positions of the clicked square and the blank one
                    blankT = Math.floor($('#square16').position().top);
                    blankL = Math.floor($('#square16').position().left);
                    currentT = Math.floor($(this).position().top);
                    currentL = Math.floor($(this).position().left);

                    // Change their positions
                    $('#square16').css({
                        left: `${currentL}px`,
                        top: `${currentT}px`,
                    });

                    $(this).css({
                        left: `${blankL}px`,
                        top: `${blankT}px`,
                    });

                    godModIsRunning = true;

                    i2 = setTimeout(function() {
                        checkVictory();
                    }, 600);
                });
            } else {
                $('.square').off('click');
                checkSquareClick();

                godModIsRunning = false;
            }
        }

        // Function - Check if a square is clicked and displays it
        function checkSquareClick() {

            // Declare variables
            let clickCounter = 0;
            let blankT = 0, blankL = 0;
            let currentT = 0, currentL = 0;
            let tempT = 0, tempL = 0;

            $('.turns').text(`Counter: ${clickCounter}`);

            if (gameIsRunning) {
                $('.square').click(function test() {

                    // Get the positions of the clicked square and the blank one
                    blankT = Math.floor($('#square16').position().top);
                    blankL = Math.floor($('#square16').position().left);
                    currentT = Math.floor($(this).position().top);
                    currentL = Math.floor($(this).position().left);

                    // Check if the clicked square is adjacent to the blank square
                    if ((currentT == (blankT - 100) && currentL == blankL) || (currentT == (blankT + 100) && currentL == blankL) || (currentT == blankT && currentL == (blankL - 100)) || (currentT == blankT && currentL == (blankL + 100))) {

                        // Change their positions
                        $('#square16').css({
                            left: `${currentL}px`,
                            top: `${currentT}px`
                        });

                        $(this).css({
                            left: `${blankL}px`,
                            top: `${blankT}px`
                        });

                        // Increase and display the click counter
                        clickCounter++;
                        $('.turns').text(`Counter: ${clickCounter}`);

                        i2 = setTimeout(function() {
                            checkVictory();
                        }, 600);
                    }
                });
            } else {
                $('.square').off('click');
            }
        }

        // Function - Check victory
        function checkVictory() {

            // Get the actual position of every square 
            let square1Position = [Math.floor($('#square1').position().left), Math.floor($('#square1').position().top)];
            let square2Position = [Math.floor($('#square2').position().left), Math.floor($('#square2').position().top)];
            let square3Position = [Math.floor($('#square3').position().left), Math.floor($('#square3').position().top)];
            let square4Position = [Math.floor($('#square4').position().left), Math.floor($('#square4').position().top)];
            let square5Position = [Math.floor($('#square5').position().left), Math.floor($('#square5').position().top)];
            let square6Position = [Math.floor($('#square6').position().left), Math.floor($('#square6').position().top)];
            let square7Position = [Math.floor($('#square7').position().left), Math.floor($('#square7').position().top)];
            let square8Position = [Math.floor($('#square8').position().left), Math.floor($('#square8').position().top)];
            let square9Position = [Math.floor($('#square9').position().left), Math.floor($('#square9').position().top)];
            let square10Position = [Math.floor($('#square10').position().left), Math.floor($('#square10').position().top)];
            let square11Position = [Math.floor($('#square11').position().left), Math.floor($('#square11').position().top)];
            let square12Position = [Math.floor($('#square12').position().left), Math.floor($('#square12').position().top)];
            let square13Position = [Math.floor($('#square13').position().left), Math.floor($('#square13').position().top)];
            let square14Position = [Math.floor($('#square14').position().left), Math.floor($('#square14').position().top)];
            let square15Position = [Math.floor($('#square15').position().left), Math.floor($('#square15').position().top)];
            let square16Position = [Math.floor($('#square16').position().left), Math.floor($('#square16').position().top)];

            // Check if the squares are at their initial positions
            if ((square1Position[0] == 0 && square1Position[1] == 0) &&
                (square2Position[0] == 100 && square2Position[1] == 0) &&
                (square3Position[0] == 200 && square3Position[1] == 0) &&
                (square4Position[0] == 300 && square4Position[1] == 0) &&
                (square5Position[0] == 0 && square5Position[1] == 100) &&
                (square6Position[0] == 100 && square6Position[1] == 100) &&
                (square7Position[0] == 200 && square7Position[1] == 100) &&
                (square8Position[0] == 300 && square8Position[1] == 100) &&
                (square9Position[0] == 0 && square9Position[1] == 200) &&
                (square10Position[0] == 100 && square10Position[1] == 200) &&
                (square11Position[0] == 200 && square11Position[1] == 200) &&
                (square12Position[0] == 300 && square12Position[1] == 200) &&
                (square13Position[0] == 0 && square13Position[1] == 300) &&
                (square14Position[0] == 100 && square14Position[1] == 300) &&
                (square15Position[0] == 200 && square15Position[1] == 300) &&
                (square16Position[0] == 300 && square16Position[1] == 300)) {

                // End the game
                gameIsRunning = false;
                checkSquareClick();
                loadTimer();

                alert('You won!');
            }
        }

        // Function - Launch the game
        function launchGame() {
            gameIsRunning = true;

            mixGame();
            loadTimer();
            checkSquareClick();
        }

        // Function - Stop the game
        function stopGame() {
            gameIsRunning = false;

            loadTimer();
            checkSquareClick();
        }

        //////////
        // MAIN //
        //////////

        // Load the game when the play button is clicked
        $('.play-button').click(function () {
            if (!gameIsRunning) {
                launchGame();
            }
        });

        // Stop the game when the stop button is clicked
        $('.stop-button').click(function () {
            if (gameIsRunning) {
                stopGame();
            }
        });

        // Watch and activate godmod
        $(window).keydown(function (event) {
            if (gameIsRunning && event.key == 'M' && event.shiftKey == true) {
                godMod();
            }
        });
    </script>
</body>

</html>